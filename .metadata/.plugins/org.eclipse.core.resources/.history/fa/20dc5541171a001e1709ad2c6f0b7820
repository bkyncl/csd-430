package kyncl_08.model;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.SQLException;

public class CreateModel {
	private DataManager dataManager;
	
	public CreateModel(DataManager dataManager) {
		this.dataManager = dataManager;
	}
	
	public void createTables() {
		Connection conn = null;
        try {
        	conn = dataManager.getConnection();
        	
        	// Create the plant_category table
            PreparedStatement categoryStatement = conn.prepareStatement("CREATE TABLE IF NOT EXISTS plant_category ("
            		 + "category_id INT NOT NULL AUTO_INCREMENT,"
                     + "category_name VARCHAR(50) NOT NULL,"
                     + "plant_count INT NOT NULL DEFAULT 0,"
                     + "PRIMARY KEY (category_name)"
                     + ")");
            categoryStatement.execute();
            
            System.out.println("category table created");
            
            // Create fruits table
            PreparedStatement fruitsStatement = conn.prepareStatement("CREATE TABLE IF NOT EXISTS fruits ("
                    + "fruit_id INT NOT NULL AUTO_INCREMENT,"
                    + "fruit_name VARCHAR(50) NOT NULL,"
                    + "category_name VARCHAR(50) NOT NULL,"
                    + "FOREIGN KEY (category_name) REFERENCES plant_category(category_name),"
                    + "PRIMARY KEY (fruit_id)"
                    + ")");
            fruitsStatement.execute();
            
            System.out.println("fruits table created");
            
            // Create vegetables table
            PreparedStatement vegetablesStatement = conn.prepareStatement("CREATE TABLE IF NOT EXISTS vegetables ("
                    + "vegetable_id INT NOT NULL AUTO_INCREMENT,"
                    + "vegetable_name VARCHAR(50) NOT NULL,"
                    + "category_name VARCHAR(50) NOT NULL,"
                    + "FOREIGN KEY (category_name) REFERENCES plant_category(category_name),"
                    + "PRIMARY KEY (vegetable_id)"
                    + ")");
            vegetablesStatement.execute();
            
            System.out.println("vegetable table created");
            
            // Create herbs table
            PreparedStatement herbsStatement = conn.prepareStatement("CREATE TABLE IF NOT EXISTS herbs ("
                    + "herb_id INT NOT NULL AUTO_INCREMENT,"
                    + "herb_name VARCHAR(50) NOT NULL,"
                    + "category_name VARCHAR(50) NOT NULL,"
                    + "FOREIGN KEY (category_name) REFERENCES plant_category(category_name),"
                    + "PRIMARY KEY (herb_id)"
                    + ")");
            herbsStatement.execute();
            
            System.out.println("herb table created");
            
            // Create triggers for all tables (fruits, vegetables, herbs)
            createTriggers("fruits");
            createTriggers("vegetables");
            createTriggers("herbs");
            
            System.out.println("triggers added for all tables");
            
            
            
        } catch (SQLException e) {
            System.out.println("Error creating table: " + e.getMessage());
        } finally {
            dataManager.endConnection(conn);
            System.out.println("connection closed");
        }
	}
	
	public void createTriggers(String tableName) {
		Connection conn = null;
	    try {
	        conn = dataManager.getConnection();
	        
	        // Create trigger for inserting new records
	        PreparedStatement insertTriggerStatement = conn.prepareStatement("CREATE TRIGGER insert_trigger AFTER INSERT ON " + tableName + " "
	                + "FOR EACH ROW "
	                + "UPDATE plant_category "
	                + "SET plant_count = plant_count + 1 "
	                + "WHERE category_name = NEW.category_name");
	        insertTriggerStatement.execute();
	        
	        // Create trigger for deleting records
	        PreparedStatement deleteTriggerStatement = conn.prepareStatement("CREATE TRIGGER delete_trigger AFTER DELETE ON " + tableName + " "
	                + "FOR EACH ROW "
	                + "UPDATE plant_category "
	                + "SET plant_count = plant_count - 1 "
	                + "WHERE category_name = OLD.category_name");
	        deleteTriggerStatement.execute();
	        
	        // Create trigger for updating records
	        PreparedStatement updateTriggerStatement = conn.prepareStatement("CREATE TRIGGER update_trigger AFTER UPDATE ON " + tableName + " "
	                + "FOR EACH ROW "
	                + "IF OLD.category_name != NEW.category_name THEN "
	                + "UPDATE plant_category "
	                + "SET plant_count = plant_count - 1 "
	                + "WHERE category_name = OLD.category_name; "
	                + "UPDATE plant_category "
	                + "SET plant_count = plant_count + 1 "
	                + "WHERE category_name = NEW.category_name; "
	                + "END IF;");
	        updateTriggerStatement.execute();
	        
	    } catch (SQLException e) {
	        System.out.println("Error creating triggers: " + e.getMessage());
	    } finally {
	        dataManager.endConnection(conn);
	    }
	}
	
	public void insertData() {
		Connection conn = null;
	    try {
	        conn = dataManager.getConnection();
	        
	        // Prepared statement for inserting into fruits table
	        PreparedStatement fruitsInsertStatement = conn.prepareStatement("INSERT INTO fruits (fruit_name, category_name) VALUES (?, ?)");
	        
	        // Prepared statement for inserting into vegetables table
	        PreparedStatement vegetablesInsertStatement = conn.prepareStatement("INSERT INTO vegetables (vegetable_name, category_name) VALUES (?, ?)");
	        
	        // Prepared statement for inserting into herbs table
	        PreparedStatement herbsInsertStatement = conn.prepareStatement("INSERT INTO herbs (herb_name, category_name) VALUES (?, ?)");
	        
	        // Use the prepared statements to insert data into the tables
	        fruitsInsertStatement.setString(1, "Apple");
	        fruitsInsertStatement.setString(2, "Fruits");
	        fruitsInsertStatement.execute();
	        
	        vegetablesInsertStatement.setString(1, "Carrot");
	        vegetablesInsertStatement.setString(2, "Vegetables");
	        vegetablesInsertStatement.execute();
	        
	        herbsInsertStatement.setString(1, "Basil");
	        herbsInsertStatement.setString(2, "Herbs");
	        herbsInsertStatement.execute();
	        
	        System.out.println("Data inserted successfully");
	        
	    } catch (SQLException e) {
	        System.out.println("Error creating triggers: " + e.getMessage());
	    } finally {
	        dataManager.endConnection(conn);
	    }
	}
}
