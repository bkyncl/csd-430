<%@ page language="java" contentType="text/html; charset=ISO-8859-1"
    pageEncoding="ISO-8859-1"%>
<%@ page import="java.util.*, java.io.*, java.sql.*" %>

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>JSP Demo Expanded</title>
</head>
<body>
	<%-- First Scriplet Section - from book example --%>
	<h2>Hello World! : (Book Example)</h2>
		<% 
			Map<String, String[]> map = request.getParameterMap();
			Object[] keys = map.keySet().toArray();
		%>
	<p>Map size = <%= map.size() %></p>
	<table border="1">
		<tr>
			<td>Map Element</td>
			<td>Par Name</td>
			<td>Par Value[s]</td>
		</tr>
		<% for (int k = 0; k < keys.length; k++) {
            String[] pars = map.get(keys[k]);
        %>
        <tr>
            <td><%= k %></td>
            <td><%= keys[k] %></td>
            <td>
                <% for (int j = 0; j < pars.length; j++) {
                    if (j > 0) { %>, <% }
                    out.print("'" + pars[j] + "'");
                } %>
            </td>
        </tr>
        <% } %>
	</table>
	
	<%-- Second Scriplet Section - expanded example --%>
	<h2>Welcome Message Scriplet</h2>
		<%
			String name = (String) session.getAttribute("name");
	        if (name == null || name.isEmpty()) {
	            if (request.getMethod().equalsIgnoreCase("POST")) {
	                name = request.getParameter("name");
	                session.setAttribute("name", name);
	                response.sendRedirect(request.getRequestURI());
	            } else {
	                out.println("<form method=\"POST\">");
	                out.println("Enter your name: <input type=\"text\" name=\"name\"><br>");
	                out.println("<input type=\"submit\" value=\"Submit\">");
	                out.println("</form>");
	            }
	        } else {
	            out.println("<p>Welcome, " + name + "!</p>");
	        }
		%>
	<h2>DB Connection Test 1</h2>
	<%-- Establish a database connection using data source and perform a query --%>
        <%@ page import="javax.naming.*" %>
        <%@ page import="javax.sql.*" %>
        <%
            Context initContext = new InitialContext();
            Context envContext  = (Context) initContext.lookup("java:/comp/env");
            DataSource dataSource = (DataSource) envContext.lookup("jdbc/databasedb");

            Connection conn = null;
            Statement stmt = null;
            ResultSet rs = null;
            String url = "jdbc:mysql://localhost:3306/databasedb";
            String user = "student1";
            String pass = "pass";

            try {

                conn = dataSource.getConnection();

                out.println("<br>Connection Success<br>");

                // Perform a sample query
                stmt = conn.createStatement();
                rs = stmt.executeQuery("SELECT * FROM address33");

                // Process the query result
                while (rs.next()) {
                    out.println(rs.getString(1));
                    out.println(rs.getString(2));
                    out.println(rs.getString(3));
                    out.println(rs.getString(4));
                    out.println(rs.getString(5));
                    out.println(rs.getString(6));
                    out.println(rs.getString(7));
                    out.println("<br>");
                }
            } catch (Exception e) {
            	out.println(e.toString());;
                out.println("<br>Connection Failure");
            } finally {
                // Close the database resources
                if (rs != null) rs.close();
                if (stmt != null) stmt.close();
                if (conn != null) conn.close();
            }
        %>
	<h2>DB Connection Test 2</h2>
        <%-- Establish a database connection and perform a query --%>
        <%
         
            try {
                // Establish the database connection
                Class.forName("com.mysql.jdbc.Driver");
                conn = DriverManager.getConnection(url,user,pass);

                out.println("<br>Connection Success<br>");

                // Perform a sample query
                stmt = conn.createStatement();
                rs = stmt.executeQuery("SELECT * FROM fans");

                // Process the query result
                while (rs.next()) {
                    out.println(rs.getString(1));
                    out.println(rs.getString(2));
                    out.println(rs.getString(3));
                    out.println(rs.getString(4));
                    out.println("<br>");
                }
            } catch (Exception e) {
                out.println(e.toString());
                out.println("<br>Connection Failure");
            } finally {
                // Close the database resources
                if (rs != null) rs.close();
                if (stmt != null) stmt.close();
                if (conn != null) conn.close();
            }
        %>
	
</body>
</html>